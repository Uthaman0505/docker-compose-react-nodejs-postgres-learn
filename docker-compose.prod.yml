# Production Docker Compose using pre-built images from GitHub Container Registry
version: '3.8'

services:
  postgres:
    container_name: database-prod
    image: postgres:15
    ports:
      - "5431:5432"
    environment:
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "sh -c 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - app-network

  server:
    container_name: server-prod
    # Update this with your actual GitHub username and repository name
    image: ghcr.io/uthaman0505/docker-compose-react-nodejs-postgres-learn/server:latest
    ports:
      - "7999:8000"
    environment:
      DATABASE_URL: "${DATABASE_URL}"
      SERVER_PORT: "${SERVER_PORT}"
      NODE_ENV: "${NODE_ENV:-production}"
      DOCKER_ENV: "true"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/users/all?page=1&limit=1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  client:
    container_name: client-prod
    # Update this with your actual GitHub username and repository name
    image: ghcr.io/uthaman0505/docker-compose-react-nodejs-postgres-learn/client:latest
    ports:
      - "4172:4173"
    environment:
      VITE_SERVER_URL: "${VITE_SERVER_URL:-http://localhost:7999}"
    depends_on:
      server:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4173/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local

# Optional: Add logging configuration
x-logging: &default-logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

# Production deployment commands:
#
# 1. Update image names with your GitHub username/repository
# 2. Set up environment variables in .env file
# 3. Login to GitHub Container Registry:
#    docker login ghcr.io -u YOUR_GITHUB_USERNAME
# 4. Pull latest images:
#    docker compose -f docker-compose.prod.yml pull
# 5. Deploy:
#    docker compose -f docker-compose.prod.yml up -d
# 6. Check status:
#    docker compose -f docker-compose.prod.yml ps
# 7. View logs:
#    docker compose -f docker-compose.prod.yml logs -f
